<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Agent Chat (Redis 히스토리)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{ --bg:#0f1216; --panel:#151a21; --text:#e6e8eb; --muted:#8a94a6; --acc:#4ea8ff; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif }
    .wrap{ max-width:980px; margin:0 auto; height:100dvh; display:flex; flex-direction:column; padding:16px }
    header{ display:flex; gap:8px; align-items:center; margin-bottom:12px }
    header h1{ font-size:16px; margin:0; color:var(--acc) }
    #chat{ flex:1; overflow:auto; padding:12px; border:1px solid #202633; border-radius:12px; background:var(--panel) }
    .msg{ display:flex; gap:8px; margin:8px 0 }
    .me{ justify-content:flex-end }
    .bubble{ max-width:75%; padding:10px 12px; border-radius:12px; word-break:break-word; white-space:pre-wrap }
    .me .bubble{ background:var(--acc); color:#06121f; border-top-right-radius:4px }
    .bot .bubble{ background:#1b2230; border-top-left-radius:4px }
    .muted{ color:var(--muted) }
    .row{ display:flex; gap:8px; align-items:center; margin-top:12px }
    #q{ flex:1; resize:none; padding:12px 44px 12px 12px; border-radius:10px; border:1px solid #202633; background:#0d1117; color:var(--text); min-height:48px }
    #send{ width:40px; height:40px; border-radius:10px; border:1px solid #202633; background:#121826; color:var(--text); cursor:pointer }
    #send:active{ transform:translateY(1px) }
    .draft-card{ margin-top:8px; border:1px solid #202633; background:#0f141c; border-radius:10px; padding:8px }
    .draft-card .head{ font-weight:600; margin-bottom:6px }
    .draft-card .to{ font-size:13px; color:var(--muted); margin-bottom:6px }
    .draft-card .body{ max-height:140px; overflow:auto; border:1px solid #202633; border-radius:8px; padding:8px; background:#0d1117; margin-bottom:8px }
    .btn{ padding:8px 10px; border:1px solid #202633; border-radius:8px; background:#121826; color:var(--text); cursor:pointer }
    #toast{ position:fixed; right:16px; bottom:16px; z-index:9999 }
    .toast{ margin-top:8px; padding:10px 12px; border-radius:8px; background:#1b2230; color:#e6e8eb; border:1px solid #202633; box-shadow:0 4px 16px rgba(0,0,0,.3) }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Agent Chat</h1>
    <span id="status" class="muted"></span>
    <span style="margin-left:auto" class="muted">Enter=Send, Shift+Enter=줄바꿈</span>
  </header>

  <div id="chat" aria-live="polite"></div>

  <div class="row">
    <textarea id="q" placeholder="무엇을 할지 입력하세요. 예) LG CNS에 첫 제안 메일 작성"></textarea>
    <button id="send" title="보내기">➤</button>
  </div>
</div>

<div id="toast"></div>

<script>
  // ===== 기본 준비 =====
  const chat = document.getElementById('chat');
  const q = document.getElementById('q');
  const sendBtn = document.getElementById('send');
  const statusEl = document.getElementById('status');
  const sid = (localStorage.getItem('sid') || crypto.randomUUID());
  localStorage.setItem('sid', sid);

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function renderMarkdownLite(s){
    let html = escapeHtml(s||'');
    html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\n/g, '<br>');
    return html;
  }
  function toast(msg, ms=2000){
    const box = document.getElementById('toast');
    const el = document.createElement('div'); el.className='toast'; el.textContent=msg;
    box.appendChild(el); setTimeout(()=>el.remove(), ms);
  }

  // ===== 메시지 렌더 =====
  function add(role, text){
    const line = document.createElement('div');
    line.className = 'msg ' + (role==='user'?'me':'bot');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = renderMarkdownLite(text||'');
    line.appendChild(bubble);
    chat.appendChild(line);
    chat.scrollTo({top: chat.scrollHeight});
    return bubble; // draft 카드 붙일 때 씀
  }

  function addDraftCard(parentBubble, d){
    const card = document.createElement('div');
    card.className = 'draft-card';
    card.innerHTML = `
      <div class="head">초안 생성됨</div>
      <div class="to">To: ${escapeHtml(d.to||'')}</div>
      <div class="head">${escapeHtml(d.subject||'')}</div>
      <div class="body">${renderMarkdownLite(d.snippet||'')}</div>
      <div style="display:flex;gap:8px">
        <button class="btn" data-id="${d.uuid}">보내기</button>
      </div>
    `;
    const btn = card.querySelector('button');
    btn.addEventListener('click', async ()=>{
      btn.disabled = true;
      try{
        const r = await fetch(`/emails/send/${encodeURIComponent(d.uuid)}`, { method:'POST' });
        if(!r.ok) throw 0; btn.textContent='보냄'; btn.style.opacity=.6; toast('메일 전송 완료');
      }catch{ btn.disabled=false; toast('전송 실패'); }
    });
    parentBubble.appendChild(card);
  }

  // ===== 히스토리 로드 (Redis 저장물 표시) =====
  async function loadHistory(){
    try{
      const res = await fetch(`/chat/history?sid=${encodeURIComponent(sid)}&limit=30`);
      if(!res.ok) return; // 없으면 조용히 패스
      const arr = await res.json(); // [{user, assistant:{text,blocks[]}, ts}]
      for(const p of arr){
        add('user', p.user||'');
        const bubble = add('assistant', p.assistant?.text||'');
        (p.assistant?.blocks||[]).forEach(b=>{
          if(b.type==='draft') addDraftCard(bubble, b);
        });
      }
    }catch{}
  }

  // ===== 전송 =====
  async function send(){
    const text = q.value.trim();
    if(!text) return;
    add('user', text);
    q.value='';
    statusEl.textContent='생성 중…';
    sendBtn.disabled = true;

    try{
      const res = await fetch('/chat', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ sid, q: text })
      });
      statusEl.textContent='';
      sendBtn.disabled = false;
      if(!res.ok){ add('assistant','[ERROR] 요청 실패'); return; }
      const obj = await res.json();
      if (obj.type === 'ASSISTANT_ONLY') {
        const bubble = add('assistant', obj.assistant?.text || '');
        (obj.assistant?.blocks||[]).forEach(b=>{
          if(b.type==='draft') addDraftCard(bubble, b);
        });
      } else if (obj.type === 'TEXT') {
        add('assistant', obj.data || '');
      } else {
        add('assistant', typeof obj==='string'? obj : JSON.stringify(obj));
      }
    }catch(e){
      statusEl.textContent=''; sendBtn.disabled=false;
      add('assistant','[ERROR] 네트워크 오류');
    }
  }

  // ===== 키보드/버튼 =====
  q.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
  });
  sendBtn.addEventListener('click', send);

  // 초기 히스토리
  loadHistory();
</script>
</body>
</html>
